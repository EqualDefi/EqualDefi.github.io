<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片和视频压缩</title>
</head>

<body>
    <h2>图片压缩</h2>
    <input type="file" id="imageFileInput">
    <button onclick="compressImage()">压缩图片</button>
    <img id="compressedImage" />

    <h2>视频压缩</h2>
    <input type="file" id="videoFileInput">
    <button onclick="compressVideo()">压缩视频</button>
    <video id="compressedVideo" controls></video>

    <script>
        function compressImage() {
            const fileInput = document.getElementById('imageFileInput');
            const img = new Image();
            img.src = URL.createObjectURL(fileInput.files[0]);

            img.onload = function () {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                // 设置目标尺寸，这里假设按比例缩小到50%
                const maxWidth = img.width * 0.5;
                const maxHeight = img.height * 0.5;

                let width = img.width;
                let height = img.height;

                if (width > maxWidth) {
                    height = height * (maxWidth / width);
                    width = maxWidth;
                }
                if (height > maxHeight) {
                    width = width * (maxHeight / height);
                    height = maxHeight;
                }

                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);

                canvas.toBlob((blob) => {
                    const compressedImage = document.getElementById('compressedImage');
                    compressedImage.src = URL.createObjectURL(blob);
                }, fileInput.files[0].type, 0.92);
            };
        }

        async function compressVideo() {
            const fileInput = document.getElementById('videoFileInput');
            const video = document.createElement('video');
            video.src = URL.createObjectURL(fileInput.files[0]);

            video.onloadedmetadata = async function () {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                // 设置目标尺寸，这里假设按比例缩小到50%
                const maxWidth = video.videoWidth * 0.5;
                const maxHeight = video.videoHeight * 0.5;

                let width = video.videoWidth;
                let height = video.videoHeight;

                if (width > maxWidth) {
                    height = height * (maxWidth / width);
                    width = maxWidth;
                }
                if (height > maxHeight) {
                    width = width * (maxHeight / height);
                    height = maxHeight;
                }

                canvas.width = width;
                canvas.height = height;

                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: true,
                    video: true
                });

                const recorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm; codecs=vp9'
                });

                const chunks = [];
                recorder.ondataavailable = (e) => {
                    chunks.push(e.data);
                };

                recorder.onstop = () => {
                    const compressedBlob = new Blob(chunks, { type: 'video/webm' });
                    const compressedVideo = document.getElementById('compressedVideo');
                    compressedVideo.src = URL.createObjectURL(compressedBlob);
                };

                recorder.start();
                const interval = setInterval(() => {
                    ctx.drawImage(video, 0, 0, width, height);
                    const canvasStream = canvas.captureStream();
                    const track = canvasStream.getVideoTracks()[0];
                    const newStream = new MediaStream([track, stream.getAudioTracks()[0]]);
                    recorder.replaceTracks(newStream.getTracks());
                }, 1000 / 30);

                video.play();
                video.onended = () => {
                    clearInterval(interval);
                    recorder.stop();
                    stream.getTracks().forEach(track => track.stop());
                };
            };
        }
    </script>
</body>

</html>